# Vegetation Index Extraction Tool (VI Extract Tool)

This tool is designed to batch calculate multiple Vegetation Indices (VIs) from RGB images, perform targeted analysis of vegetation areas using background segmentation technology, and finally generate visualization results and statistical data.


## Features

- **Multiple VI Support**: Built-in calculation for 14 commonly used vegetation indices, including EXR, MGRVI, NGRDI, EXG, EXGR, etc.
- **Background Segmentation**: Automatic background-vegetation area segmentation based on decision tree model.
- **Normalization**: Foreground pixel normalization for vegetation areas to improve comparability between different images.
- **Batch Processing**: Supports batch processing of all images in directories and subdirectories.
- **Multi-format Support**: Compatible with common image formats such as TIFF (including 32-bit), JPG, PNG.
- **Rich Output**: Generates VI TIFF files, visualization images, and statistical data CSV tables.


## Dependencies Installation

Ensure the following dependency libraries are installed before use:

```bash
pip install rasterio numpy pandas scikit-learn opencv-python matplotlib
```


## Usage

### 1. Preparation

- Prepare vegetation sample images (for model training)
- Prepare background sample images (for model training)
- Images to be processed (supporting subdirectory structure)


### 2. Parameter Configuration

Configure the following parameters in the `main()` function:

```python
# Training sample paths
VEGETATION_SAMPLE = "Training_set/vegetation.png"  # Vegetation sample image
BACKGROUND_SAMPLE = "Training_set/background.png"  # Background sample image

# Input and output directories
INPUT_ROOT_DIR = "data/"       # Root directory for input images
OUTPUT_ROOT_DIR = "result/"    # Root directory for output results

# Supported image formats
IMAGE_EXTENSIONS = ["*.tif", "*.tiff", "*.jpg", "*.jpeg", "*.png"]
```


### 3. Run the Program

```bash
python vi_extract.py
```


## Output Results

The program will generate results corresponding to the input directory structure under the output root directory:

- **Single Image Result Directory**: Each image has a corresponding subdirectory containing:
  - Background segmentation mask image (`*_mask.png`)
  - TIFF files for each vegetation index (`*.tif`)
  - Visualization images for each vegetation index (PNG format)
  - Normalized vegetation index TIFF and visualization images (`*_norm.tif` and corresponding PNG)

- **Statistical Data**: CSV files generated by input subdirectory, including:
  - Image path and name
  - Mean value of each vegetation index (with 10% extreme values removed)
  - Mean value of each normalized vegetation index


## Supported Vegetation Indices

| Abbreviation | Full Name | Purpose |
|--------------|-----------|---------|
| EXR | Excess Red | Excess red index |
| MGRVI | Modified Green-Red Vegetation Index | Improved green-red vegetation index |
| NGRDI | Normalized Green-Red Difference Index | Normalized green-red difference index |
| RGRI | Red-Green Ratio Index | Red-green ratio index |
| VGBDI | Visible Green-Blue Difference Index | Visible green-blue difference index |
| EXG | Excess Green | Excess green index |
| EXGR | Excess Green minus Excess Red | Excess green minus excess red |
| VEG | Vegetation Index | General vegetation index |
| CIVE | Color Index of Vegetation Extraction | Vegetation extraction color index |
| RGBVI | RGB Vegetation Index | RGB vegetation index |
| GLI | Green Leaf Index | Green leaf index |
| VARI | Visible Atmospherically Resistant Index | Visible atmospherically resistant index |
| WI | Water Index | Water content index |
| COM | Composite Index | Composite index (weighted combination of multiple indices) |


## Processing Flow Explanation

1. **Model Training**: Train a decision tree classifier using provided vegetation and background samples.
2. **Image Reading**: Support reading multiple formats, automatically convert to RGB format and normalize.
3. **Background Segmentation**: Perform vegetation/background segmentation on each image to generate masks.
4. **Index Calculation**: Calculate all vegetation indices, set background areas to NaN.
5. **Normalization**: Perform min-max normalization on vegetation areas.
6. **Result Saving**: Save TIFF data, visualization images, and statistical results.


## Notes

- The quality of training samples directly affects background segmentation results; it is recommended to select representative samples.
- For images with insufficient foreground pixels (<10), some results may be empty.
- TIFF files retain geographic coordinate information, which can be used for subsequent GIS analysis.
- Chinese display is configured, and chart titles and labels support Chinese characters.


# 植被指数提取工具 (VI Extract Tool)

该工具用于从RGB图像中批量计算多种植被指数（Vegetation Index），并结合背景分割技术对植被区域进行针对性分析，最终生成可视化结果和统计数据。

## 功能特点

- **多植被指数支持**：内置14种常用植被指数计算，包括EXR、MGRVI、NGRDI、EXG、EXGR等
- **背景分割**：基于决策树模型的自动背景与植被区域分割
- **归一化处理**：针对植被区域进行前景像素归一化，提高不同图像间的可比性
- **批量处理**：支持对目录及子目录下的所有图像进行批量处理
- **多格式支持**：兼容TIFF（含32位）、JPG、PNG等常见图像格式
- **丰富输出**：生成植被指数TIFF文件、可视化图像及统计数据CSV表格

## 安装依赖

使用前请确保安装以下依赖库：

```bash
pip install rasterio numpy pandas scikit-learn opencv-python matplotlib
```

## 使用方法

### 1. 准备工作

- 准备植被样本图像（用于模型训练）
- 准备背景样本图像（用于模型训练）
- 待处理的图像文件（支持子目录结构）

### 2. 参数配置

在`main()`函数中配置以下参数：

```python
# 训练样本路径
VEGETATION_SAMPLE = "Training_set/vegetation.png"  # 植被样本图像
BACKGROUND_SAMPLE = "Training_set/background.png"  # 背景样本图像

# 输入输出目录
INPUT_ROOT_DIR = "data/"       # 输入图像根目录
OUTPUT_ROOT_DIR = "result/"    # 输出结果根目录

# 支持的图像格式
IMAGE_EXTENSIONS = ["*.tif", "*.tiff", "*.jpg", "*.jpeg", "*.png"]
```

### 3. 运行程序

```bash
python vi_extract.py
```

## 输出结果

程序会在输出根目录下生成与输入目录结构对应的结果：

- **单图像结果目录**：每个图像对应一个子目录，包含：
  - 背景分割掩码图像（`*_mask.png`）
  - 各植被指数TIFF文件（`*.tif`）
  - 各植被指数可视化图像（PNG格式）
  - 归一化后的植被指数TIFF及可视化图像（`*_norm.tif`及对应PNG）

- **统计数据**：按输入子目录生成CSV文件，包含：
  - 图像路径及名称
  - 各植被指数的均值（去除10%极端值）
  - 归一化后各植被指数的均值

## 支持的植被指数

| 缩写 | 全称 | 用途 |
|------|------|------|
| EXR | Excess Red | 过量红光指数 |
| MGRVI | Modified Green-Red Vegetation Index | 改进型绿红植被指数 |
| NGRDI | Normalized Green-Red Difference Index | 归一化绿红差异指数 |
| RGRI | Red-Green Ratio Index | 红绿比值指数 |
| VGBDI | Visible Green-Blue Difference Index | 可见绿蓝差异指数 |
| EXG | Excess Green | 过量绿光指数 |
| EXGR | Excess Green minus Excess Red | 过量绿光减过量红光 |
| VEG | Vegetation Index | 植被指数 |
| CIVE | Color Index of Vegetation Extraction | 植被提取颜色指数 |
| RGBVI | RGB Vegetation Index | RGB植被指数 |
| GLI | Green Leaf Index | 绿叶指数 |
| VARI | Visible Atmospherically Resistant Index | 可见光大气阻抗指数 |
| WI | Water Index | 水分指数 |
| COM | Composite Index | 复合指数（多种指数加权） |

## 处理流程说明

1. **模型训练**：使用提供的植被和背景样本训练决策树分类器
2. **图像读取**：支持多种格式图像读取，自动转换为RGB格式并归一化
3. **背景分割**：对每张图像进行植被/背景分割，生成掩码
4. **指数计算**：计算所有植被指数，背景区域设为NaN
5. **归一化**：对植被区域进行min-max归一化
6. **结果保存**：保存TIFF数据、可视化图像及统计结果

## 注意事项

- 训练样本质量直接影响背景分割效果，建议选择代表性强的样本
- 对于前景像素不足（<10个）的图像，部分结果可能为空
- TIFF文件支持地理坐标信息保留，可用于后续GIS分析
- 中文显示已配置，图表标题和标签支持中文显示
